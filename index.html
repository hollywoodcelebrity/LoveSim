<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Love Simulator</title>
    <style id="game-style"></style>
</head>
<body>
    <div id="game-container">
        <div id="stage-1" class="game-stage active"></div>
        <div id="stage-2" class="game-stage"></div>
        <div id="stage-3" class="game-stage"></div>
        <div id="conclusion" class="game-stage"></div>
    </div>
    
    <script id="game-script"></script>

    <script>
        const cssContent = document.getElementById('game-style');
        const jsContent = document.getElementById('game-script');
        
        // --- INJECTING CSS CONTENT ---
        cssContent.innerHTML = `
            body {
                width: 100vw; height: 100vh;
                display: flex; justify-content: center; align-items: center;
                margin: 0; background-color: #111; color: white;
                font-family: 'Arial', sans-serif; overflow: hidden; box-sizing: border-box;
            }
            #game-container { width: 100%; height: 100%; position: relative; }
            .game-stage {
                display: none; width: 100%; height: 100%; position: absolute;
                top: 0; left: 0; justify-content: center; align-items: center;
                flex-direction: column; transition: opacity 0.5s;
                text-align: center; padding: 20px; box-sizing: border-box;
            }
            .game-stage.active { display: flex; }

            #profiles-container {
                display: flex; justify-content: space-around; 
                width: 90vw; height: 75vh; align-items: flex-end;
            }
            .profile-wrapper {
                position: relative; width: 35vw; height: 65vh; 
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
            }
            .profile-image { width: 100%; height: 100%; object-fit: contain; }
            
            @keyframes radial-pulse {
                0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0.9; }
                100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
            }

            @keyframes approach-circle {
                0% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
                20% { opacity: 0.4; }
                100% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; }
            }

            .profile-wrapper.target::before, .profile-wrapper.target::after {
                content: ''; position: absolute; top: 50%; left: 50%;
                width: 100%; height: 100%; border-radius: 50%;
                border: 2px solid #ff477e; transform: translate(-50%, -50%) scale(0.1);
                animation: radial-pulse 2s linear infinite; z-index: -1;
            }
            .profile-wrapper.target::after { animation-delay: 1s; }

            .approach-ring {
                position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
                border-radius: 50%; border: 1px dashed rgba(255, 255, 255, 0.5);
                animation: approach-circle 2s linear infinite; z-index: -1;
            }

            @keyframes playerFlash {
                0% { box-shadow: 0 0 0 rgba(0, 255, 200, 0); }
                50% { box-shadow: 0 0 20px 5px #00ffc8; } 
                100% { box-shadow: 0 0 0 rgba(0, 255, 200, 0); }
            }
            #player-profile.flash { animation: playerFlash 0.2s ease-out; }

            #judgment-text {
                font-size: 2.5em; font-weight: bold; height: 1.2em; margin-bottom: 10px;
                text-shadow: 0 0 10px rgba(255,255,255,0.5);
            }
            #sync-message { font-size: 1.2em; margin-bottom: 10px; opacity: 0.7; }

            /* MICROBE STYLES */
            #microbe-container {
                width: 80%; max-width: 600px; aspect-ratio: 16 / 9; 
                border: 2px solid #5a5a5a; position: relative; background-color: #000033; 
                margin-top: 20px;
            }
            .microbe {
                width: 20px; height: 20px; border-radius: 50%; position: absolute;
                cursor: grab; transition: background-color 0.5s; opacity: 0.9;
            }
            .microbe.red { background-color: #ff6347; }
            .microbe.blue { background-color: #4682b4; }

            /* STAGE 3 HEAT */
            #heat-profiles {
                width: 400px; height: 150px; max-width: 90%; position: relative;
                background-color: #333; margin: 20px 0;
            }
            .heat-overlay {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(255, 69, 0, 0); transition: background-color 0.1s;
            }
        `;

        // --- INJECTING JAVASCRIPT CONTENT ---
        jsContent.innerHTML = `
            document.addEventListener('DOMContentLoaded', () => {
                const stage1 = document.getElementById('stage-1');
                const stage2 = document.getElementById('stage-2');
                const stage3 = document.getElementById('stage-3');
                const conclusion = document.getElementById('conclusion');

                const targetInterval = 2000; 
                let playerClicks = [];
                const perfectThreshold = 250; 
                const goodThreshold = 500;
                let lastTargetBeat = performance.now();

                function initStage1() {
                    stage1.innerHTML = \`
                        <h2>Stage 1: Neural Synchronization</h2>
                        <div id="judgment-text"></div>
                        <p id="sync-message">Click when the white ring shrinks to the center!</p>
                        <div id="profiles-container">
                            <div class="profile-wrapper" id="player-profile">
                                <img src="player_profile.png" alt="Player" class="profile-image">
                            </div>
                            <div class="profile-wrapper target" id="target-profile">
                                <img src="target_profile.png" alt="Target" class="profile-image">
                                <div class="approach-ring"></div>
                            </div>
                        </div>
                        <h3 id="score-display">Matched: 0 / 5</h3>
                    \`;
                    
                    setInterval(() => { lastTargetBeat = performance.now(); }, targetInterval);
                    document.addEventListener('click', handleSyncClick);
                }

                function handleSyncClick() {
                    if (!stage1.classList.contains('active')) return;
                    
                    const clickTime = performance.now();
                    const timeSinceLastBeat = (clickTime - lastTargetBeat) % targetInterval;
                    const diff = Math.min(timeSinceLastBeat, targetInterval - timeSinceLastBeat); 
                    
                    const judgment = document.getElementById('judgment-text');
                    const scoreDisplay = document.getElementById('score-display');
                    const playerProfile = document.getElementById('player-profile');

                    playerProfile.classList.remove('flash');
                    void playerProfile.offsetWidth; 
                    playerProfile.classList.add('flash');

                    if (diff <= perfectThreshold) {
                        playerClicks.push('synced');
                        judgment.textContent = "PERFECT!";
                        judgment.style.color = "#00ffc8";
                    } else if (diff <= goodThreshold) {
                        playerClicks.push('synced');
                        judgment.textContent = "GREAT!";
                        judgment.style.color = "#ffdd00";
                    } else {
                        playerClicks = []; 
                        judgment.textContent = timeSinceLastBeat > 1000 ? "TOO EARLY" : "TOO LATE";
                        judgment.style.color = "#ff477e";
                    }

                    scoreDisplay.textContent = "Matched: " + playerClicks.length + " / 5";

                    if (playerClicks.length >= 5) {
                        document.removeEventListener('click', handleSyncClick);
                        judgment.textContent = "SYNCHRONIZED!";
                        judgment.style.color = "white";
                        setTimeout(() => {
                            stage1.classList.remove('active');
                            stage2.classList.add('active');
                            initStage2();
                        }, 1500);
                    }
                }

                function initStage2() {
                    stage2.innerHTML = \`<h2>Stage 2: Microbial Exchange</h2><p>The profiles approach...</p><div id="zoom-bullseye" style="padding:20px; background:orange; cursor:pointer; border-radius:10px;">ZOOM IN</div>\`;
                    document.getElementById('zoom-bullseye').onclick = renderMicrobeView;
                }

                function renderMicrobeView() {
                    stage2.innerHTML = \`<h3>Mixing Microbiota (Drag to Center)</h3><div id="microbe-container"></div><p id="mix-status">Mixed: 0 / 10</p>\`;
                    const container = document.getElementById('microbe-container');
                    let mixedCount = 0;
                    for (let i = 0; i < 20; i++) {
                        const m = document.createElement('div');
                        m.className = 'microbe ' + (i < 10 ? 'red' : 'blue');
                        m.id = 'microbe-' + i;
                        m.style.left = (i < 10 ? Math.random()*20 + 5 : Math.random()*20 + 75) + '%';
                        m.style.top = Math.random()*85 + '%';
                        m.draggable = true;
                        m.ondragstart = (e) => e.dataTransfer.setData("text", e.target.id);
                        container.appendChild(m);
                    }
                    container.ondragover = (e) => e.preventDefault();
                    container.ondrop = (e) => {
                        e.preventDefault();
                        const id = e.dataTransfer.getData("text");
                        const el = document.getElementById(id);
                        const rect = container.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        el.style.left = (x - 10) + 'px';
                        el.style.top = (y - 10) + 'px';
                        if (!el.dataset.isMixed && Math.abs(x - rect.width/2) < rect.width/5) {
                            el.style.backgroundColor = 'purple';
                            el.dataset.isMixed = "true";
                            mixedCount++;
                            document.getElementById('mix-status').textContent = "Mixed: " + mixedCount + " / 10";
                            if (mixedCount >= 10) setTimeout(initStage3, 1000);
                        }
                    };
                }

                function initStage3() {
                    stage2.classList.remove('active');
                    stage3.classList.add('active');
                    stage3.innerHTML = \`<h2>Stage 3: Vasodilation</h2><div id="heat-profiles"><div class="heat-overlay" id="heat-overlay"></div></div><p>Press SPACE repeatedly to heat up!</p><p id="heat-level">Heat: 0%</p>\`;
                    let presses = 0;
                    const spaceHandler = (e) => {
                        if (e.code === 'Space') {
                            presses++;
                            const pct = Math.min(100, (presses / 30) * 100);
                            document.getElementById('heat-level').textContent = "Heat: " + Math.round(pct) + "%";
                            document.getElementById('heat-overlay').style.backgroundColor = "rgba(255, 69, 0, " + (pct/150) + ")";
                            if (presses >= 30) {
                                document.removeEventListener('keydown', spaceHandler);
                                goToOxytocin();
                            }
                        }
                    };
                    document.addEventListener('keydown', spaceHandler);
                }

                function goToOxytocin() {
                    const formula = 'C43H66N12O12S2';
                    stage3.innerHTML = \`<h3>Synthesis: Oxytocin</h3><p>Type the formula to release: <br><strong>\${formula}</strong></p><input type="text" id="oxy-input" style="padding:10px; font-size:1.2em; text-align:center;"><p id="oxy-status">Match the text exactly!</p>\`;
                    const input = document.getElementById('oxy-input');
                    input.focus();
                    input.oninput = (e) => {
                        if (e.target.value.toUpperCase() === formula) {
                            stage3.classList.remove('active');
                            conclusion.classList.add('active');
                            conclusion.innerHTML = "<h1>OXYTOCIN RELEASED!<br>YOU ARE IN LOVE!</h1>";
                        }
                    };
                }

                initStage1();
            });
        `;
    </script>
</body>
</html>
