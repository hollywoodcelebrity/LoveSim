<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Love Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            margin: 0; background-color: white; color: black;
            font-family: "Source Code Pro", monospace; overflow: hidden; box-sizing: border-box;
        }
        #game-container { width: 100%; height: 100%; position: relative; }
        .game-stage {
            display: none; width: 100%; height: 100%; position: absolute;
            top: 0; left: 0; justify-content: center; align-items: center;
            flex-direction: column; transition: opacity 0.5s;
            padding: 40px; box-sizing: border-box;
        }
        .game-stage.active { display: flex; }

        .text-header-container {
            width: 100%; text-align: left; margin-bottom: 20px; max-width: 90vw;
            z-index: 100; pointer-events: none;
        }

        #profiles-container {
            display: flex; justify-content: space-around; 
            width: 90vw; height: 60vh; align-items: flex-end;
            margin-top: auto;
        }
        .profile-wrapper { position: relative; width: 35vw; height: 55vh; background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        @keyframes radial-pulse {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0.9; }
            100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
        }
        @keyframes approach-circle {
            0% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
            20% { opacity: 0.4; }
            100% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; }
        }

        .profile-wrapper.target::before, .profile-wrapper.target::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 100%; height: 100%; border-radius: 50%;
            border: 3px solid #39ff14; transform: translate(-50%, -50%) scale(0.1);
            animation: radial-pulse 4s linear infinite; z-index: -1;
        }
        .profile-wrapper.target::after { animation-delay: 2s; }

        .player-ripple {
            position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid #afeeee;
            transform: translate(-50%, -50%) scale(0.1);
            opacity: 0; pointer-events: none; z-index: -1;
        }
        .ripple-active { animation: radial-pulse 4s linear forwards; }

        #three-container, #microbe-full-container { 
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh; 
            background: white; z-index: 1;
        }

        .microbe { 
            width: 45px; height: 45px; border-radius: 50%; 
            position: absolute; cursor: grab; border: 1px solid black; 
            z-index: 10; transition: background-color 0.3s;
        }

        #vaso-tide {
            position: absolute; bottom: 0; left: 0;
            width: 100vw; height: 0%;
            background: black;
            transition: height 0.3s ease-out;
            z-index: 5;
        }

        .final-declaration {
            color: #39ff14;
            font-size: 5rem;
            font-weight: 700;
            text-align: center;
            animation: slow-blink 2s steps(2, start) infinite;
        }
        @keyframes slow-blink { to { visibility: hidden; } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="stage-1" class="game-stage active"></div>
        <div id="stage-2" class="game-stage"></div>
        <div id="stage-3" class="game-stage"></div>
        <div id="conclusion" class="game-stage"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const stage1 = document.getElementById("stage-1");
        const stage2 = document.getElementById("stage-2");
        const stage3 = document.getElementById("stage-3");
        const conclusion = document.getElementById("conclusion");
        
        let audioCtx;
        function triggerHeartbeat(volume = 0.5) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'sine'; osc1.frequency.setValueAtTime(55, now);
            osc1.frequency.exponentialRampToValueAtTime(0.01, now + 0.12);
            gain1.gain.setValueAtTime(volume, now); gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
            osc1.connect(gain1); gain1.connect(audioCtx.destination);
            osc1.start(); osc1.stop(now + 0.12);
        }

        const targetInterval = 4000; 
        let playerClicks = [];
        let lastTargetBeat = performance.now();

        const stage1ClickListener = () => {
            if (stage1.classList.contains("active")) {
                triggerHeartbeat(0.4);
                handleSyncClick();
            }
        };

        function initStage1() {
            stage1.innerHTML = `
                <div class="text-header-container">
                    <h2>STAGE 1: NEURAL_SYNC</h2>
                    <div id="judgment-text" style="font-size:2em; font-weight:bold; height:1.2em; margin:10px 0;">STATUS: AWAITING_INPUT</div>
                    <p>CLICK WHEN NEON RINGS HIT CENTER</p>
                </div>
                <div id="profiles-container">
                    <div class="profile-wrapper" id="p1" style="background-image:url('player_profile.png')">
                        <div id="player-ripple-1" class="player-ripple"></div>
                    </div>
                    <div class="profile-wrapper target" id="p2" style="background-image:url('target_profile.png')">
                        <div class="approach-ring" style="position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; border-radius: 50%; border: 2px dashed rgba(0, 0, 0, 0.1); animation: approach-circle 4s linear infinite; z-index: -1;"></div>
                    </div>
                </div>
                <h3 id="score-display" style="text-align:center; width:100%;">MATCH_COUNT: 0 / 5</h3>`;
            
            setInterval(() => { if (stage1.classList.contains("active")) lastTargetBeat = performance.now(); }, targetInterval);
            document.addEventListener("click", stage1ClickListener);
        }

        function handleSyncClick() {
            const diff = Math.min((performance.now() - lastTargetBeat) % targetInterval, targetInterval - ((performance.now() - lastTargetBeat) % targetInterval));
            const ripple = document.getElementById("player-ripple-1");
            if(ripple) { ripple.classList.remove("ripple-active"); void ripple.offsetWidth; ripple.classList.add("ripple-active"); }
            if (diff <= 500) { playerClicks.push("synced"); document.getElementById("judgment-text").textContent = "STATUS: PERFECT"; }
            else { playerClicks = []; document.getElementById("judgment-text").textContent = "STATUS: MISSED"; }
            document.getElementById("score-display").textContent = "MATCH_COUNT: " + playerClicks.length + " / 5";
            if (playerClicks.length >= 5) { 
                document.removeEventListener("click", stage1ClickListener);
                setTimeout(initStage2, 1000); 
            }
        }

        function initStage2() {
            stage1.classList.remove("active");
            stage2.classList.add("active");
            stage2.innerHTML = `<div id="zoom-bullseye" style="padding:20px; border:2px solid black; cursor:pointer; font-weight:bold; background: white; z-index: 100;">INIT_ZOOM</div>`;
            document.getElementById("zoom-bullseye").onclick = run3DIntestine;
        }

        function run3DIntestine() {
            stage2.innerHTML = `<div id="three-container" style="position:absolute; inset:0;"></div>`;
            const container = document.getElementById("three-container");
            const scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff);
            const camera = new THREE.PerspectiveCamera(85, window.innerWidth/window.innerHeight, 0.01, 3000);
            const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 3.5));
            const loader = new GLTFLoader();
            loader.load('SMALL_INTESTINE.glb', (gltf) => {
                const model = gltf.scene; const box = new THREE.Box3().setFromObject(model); const size = box.getSize(new THREE.Vector3());
                model.position.sub(box.getCenter(new THREE.Vector3()));
                model.rotation.y = (140 * Math.PI / 180); model.position.x -= 0.5; scene.add(model);
                let z = -size.z * 0.15;
                const onKey = (e) => {
                    if (e.key === "ArrowUp") z += (size.z / 250);
                    if (z >= size.z * 1.5) { window.removeEventListener("keydown", onKey); renderer.dispose(); renderMicrobeView(); }
                };
                window.addEventListener("keydown", onKey);
                function animate() { if (!stage2.classList.contains("active")) return; requestAnimationFrame(animate); camera.position.z = z; camera.lookAt(0,0,z+1); renderer.render(scene, camera); }
                animate();
            });
        }

        function renderMicrobeView() {
            stage2.innerHTML = `<div id="microbe-full-container" style="position:absolute; inset:0;"></div>`;
            const container = document.getElementById("microbe-full-container");
            let mixed = 0;
            for (let i = 0; i < 20; i++) {
                const m = document.createElement("div"); m.className = "microbe";
                m.style.backgroundColor = i < 10 ? "#afeeee" : "#39ff14";
                m.style.left = Math.random() * 90 + "vw"; m.style.top = Math.random() * 80 + "vh";
                container.appendChild(m);

                let startTime = Date.now() + Math.random() * 1000;
                function move() {
                    if (!m.parentNode) return;
                    let time = (Date.now() - startTime) * 0.001;
                    let x = Math.sin(time * 0.7) * 20;
                    let y = Math.cos(time * 0.5) * 20;
                    m.style.transform = `translate(${x}px, ${y}px)`;
                    requestAnimationFrame(move);
                }
                move();

                m.onmousedown = (e) => {
                    let moveHandler = (ev) => {
                        m.style.left = ev.clientX - 22 + "px"; m.style.top = ev.clientY - 22 + "px";
                        if (!m.dataset.done && Math.abs(ev.clientX - window.innerWidth/2) < 100) {
                            m.dataset.done = "true"; m.style.backgroundColor = "#333"; mixed++;
                            if (mixed >= 10) setTimeout(initStage3, 800);
                        }
                    };
                    window.onmousemove = moveHandler;
                    window.onmouseup = () => window.onmousemove = null;
                };
            }
        }

        function initStage3() {
            stage2.classList.remove("active"); stage3.classList.add("active");
            stage3.innerHTML = `<div id="vaso-tide"></div><h2 style="z-index:10; position:relative;">STAGE 3: VASODILATION</h2>`;
            let p = 0;
            const vasoSpaceHandler = (e) => {
                if (e.code === "Space") {
                    p++; triggerHeartbeat(0.5);
                    document.getElementById("vaso-tide").style.height = (p/40)*100 + "%";
                    if (p >= 40) { window.removeEventListener("keydown", vasoSpaceHandler); goToOxytocin(); }
                }
            };
            window.addEventListener("keydown", vasoSpaceHandler);
        }

        function goToOxytocin() {
            stage3.innerHTML = `<div style="position:absolute; inset:0; background:black; z-index:1;"></div>
                <div style="z-index:10; color:white; text-align:center;">
                    <h3>SYNTHESIS: OXYTOCIN</h3>
                    <input type="text" id="oxy" spellcheck="false" autocomplete="off" style="background:none; border:2px solid white; color:white; padding:10px; font-family:inherit; text-align:center; outline:none;">
                    <p style="font-size:0.7em; margin-top:10px; opacity:0.5;">REQ: C43H66N12O12S2</p>
                </div>`;
            const input = document.getElementById("oxy"); input.focus();
            document.onclick = () => { if (input) input.focus(); };
            input.oninput = (e) => {
                if (e.target.value.toUpperCase() === "C43H66N12O12S2") {
                    document.onclick = null;
                    stage3.classList.remove("active");
                    conclusion.classList.add("active");
                    conclusion.innerHTML = `<div style="text-align:center"><h3>STATUS: STABILIZED</h3></div>`;
                    setTimeout(() => {
                        conclusion.style.backgroundColor = "white";
                        conclusion.innerHTML = `<div class="final-declaration">YOU ARE IN LOVE.</div>`;
                    }, 2500);
                }
            };
        }
        initStage1();
    </script>
</body>
</html>
