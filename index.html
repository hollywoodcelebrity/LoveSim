<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Love Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            margin: 0; background-color: white; color: black;
            font-family: "Source Code Pro", monospace; overflow: hidden; box-sizing: border-box;
        }
        #game-container { width: 100%; height: 100%; position: relative; }
        .game-stage {
            display: none; width: 100%; height: 100%; position: absolute;
            top: 0; left: 0; justify-content: center; align-items: center;
            flex-direction: column; transition: opacity 0.5s;
            padding: 40px; box-sizing: border-box;
        }
        .game-stage.active { display: flex; }

        .text-header-container {
            width: 100%; text-align: left; margin-bottom: 20px; max-width: 90vw;
            z-index: 100; pointer-events: none;
        }

        #profiles-container {
            display: flex; justify-content: space-around; 
            width: 90vw; height: 60vh; align-items: flex-end;
            margin-top: auto;
        }
        .profile-wrapper { position: relative; width: 35vw; height: 55vh; }
        .profile-image { width: 100%; height: 100%; object-fit: contain; }
        
        @keyframes radial-pulse {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0.9; }
            100% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; }
        }
        @keyframes approach-circle {
            0% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
            20% { opacity: 0.4; }
            100% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; }
        }

        .profile-wrapper.target::before, .profile-wrapper.target::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 100%; height: 100%; border-radius: 50%;
            border: 3px solid #39ff14; transform: translate(-50%, -50%) scale(0.1);
            animation: radial-pulse 4s linear infinite; z-index: -1;
            filter: drop-shadow(0 0 5px #39ff14);
        }
        .profile-wrapper.target::after { animation-delay: 2s; }

        .approach-ring {
            position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            border-radius: 50%; border: 2px dashed rgba(0, 0, 0, 0.1);
            animation: approach-circle 4s linear infinite; z-index: -1;
        }

        .player-ripple {
            position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            border-radius: 50%; border: 3px solid #afeeee;
            transform: translate(-50%, -50%) scale(0.1);
            opacity: 0; pointer-events: none; z-index: -1;
        }
        .ripple-active { animation: radial-pulse 4s linear forwards; }

        #three-container, #microbe-full-container { 
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh; 
            background: white; z-index: 1;
        }

        #zoom-ui { 
            position: absolute; bottom: 40px; right: 40px; 
            color: black; background: rgba(255,255,255,0.9); 
            padding: 15px; border: 1px solid black; font-size: 0.9em; 
            pointer-events: none; z-index: 100;
        }
        #zoom-bar-container { width: 150px; height: 6px; background: #eee; margin-top: 10px; border: 1px solid #ddd; }
        #zoom-bar-fill { width: 0%; height: 100%; background: #afeeee; transition: width 0.1s; }

        /* MICROBE STYLING */
        @keyframes microbe-float {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(10px, -15px); }
            50% { transform: translate(-5px, 10px); }
            75% { transform: translate(15px, 5px); }
        }

        .microbe { 
            width: 45px; height: 45px; border-radius: 50%; 
            position: absolute; cursor: grab; border: 2px solid black; 
            transition: background-color 0.3s, transform 0.1s; 
            z-index: 10;
            animation: microbe-float 6s ease-in-out infinite;
        }
        .microbe:active { cursor: grabbing; animation: none; }

        #mix-status-floating {
            position: absolute; bottom: 40px; left: 40px;
            background: rgba(255,255,255,0.9); border: 1px solid black;
            padding: 15px; font-weight: bold; z-index: 100;
        }

        #center-lane {
            position: absolute; left: 50%; top: 0;
            width: 20vw; height: 100vh; transform: translateX(-50%);
            border-left: 1px dashed rgba(0,0,0,0.1);
            border-right: 1px dashed rgba(0,0,0,0.1);
            background: rgba(0,0,0,0.02);
            pointer-events: none; z-index: 0;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="stage-1" class="game-stage active"></div>
        <div id="stage-2" class="game-stage"></div>
        <div id="stage-3" class="game-stage"></div>
        <div id="conclusion" class="game-stage"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const stage1 = document.getElementById("stage-1");
        const stage2 = document.getElementById("stage-2");
        const stage3 = document.getElementById("stage-3");
        const targetInterval = 4000; 
        let playerClicks = [];
        let lastTargetBeat = performance.now();

        function initStage1() {
            stage1.innerHTML = `
                <div class="text-header-container">
                    <h2>STAGE 1: NEURAL_SYNC</h2>
                    <div id="judgment-text" style="font-size:2em; font-weight:bold; height:1.2em; margin:10px 0;">STATUS: AWAITING_INPUT</div>
                    <p>CLICK WHEN NEON RINGS HIT CENTER</p>
                </div>
                <div id="profiles-container">
                    <div class="profile-wrapper" id="player-profile">
                        <img src="player_profile.png" alt="P1" class="profile-image">
                        <div id="player-ripple-1" class="player-ripple"></div>
                    </div>
                    <div class="profile-wrapper target" id="target-profile">
                        <img src="target_profile.png" alt="T1" class="profile-image">
                        <div class="approach-ring"></div>
                    </div>
                </div>
                <h3 id="score-display" style="text-align:center; width:100%;">MATCH_COUNT: 0 / 5</h3>`;
            
            setInterval(() => { lastTargetBeat = performance.now(); }, targetInterval);
            document.addEventListener("click", handleSyncClick);
        }

        function handleSyncClick() {
            if (!stage1.classList.contains("active")) return;
            const diff = Math.min((performance.now() - lastTargetBeat) % targetInterval, targetInterval - ((performance.now() - lastTargetBeat) % targetInterval));
            
            const ripple = document.getElementById("player-ripple-1");
            if(ripple) { 
                ripple.classList.remove("ripple-active"); 
                void ripple.offsetWidth; 
                ripple.classList.add("ripple-active"); 
            }

            if (diff <= 500) { 
                playerClicks.push("synced"); 
                document.getElementById("judgment-text").textContent = "STATUS: PERFECT"; 
            } else { 
                playerClicks = []; 
                document.getElementById("judgment-text").textContent = "STATUS: MISSED"; 
            }

            document.getElementById("score-display").textContent = "MATCH_COUNT: " + playerClicks.length + " / 5";
            if (playerClicks.length >= 5) { 
                document.removeEventListener("click", handleSyncClick); 
                setTimeout(initStage2, 1000); 
            }
        }

        function initStage2() {
            stage1.classList.remove("active");
            stage2.classList.add("active");
            stage2.innerHTML = `
                <div class="text-header-container">
                    <h2>STAGE 2: MICROBIAL_EXCHANGE</h2>
                </div>
                <div id="zoom-bullseye" style="padding:20px; border:2px solid black; cursor:pointer; font-weight:bold; background: white; z-index: 100;">INIT_ZOOM</div>`;
            document.getElementById("zoom-bullseye").onclick = run3DIntestine;
        }

        function run3DIntestine() {
            stage2.innerHTML = `
                <div class="text-header-container">
                    <h3>ANATOMICAL_MAP: SMALL_INTESTINE</h3>
                    <p style="font-size:0.8em; opacity:0.7;">UP ARROW: TRAVERSE // DOWN ARROW: RETRACT</p>
                </div>
                <div id="three-container"></div>
                <div id="zoom-ui">
                    PENETRATION_DEPTH
                    <div id="zoom-bar-container"><div id="zoom-bar-fill"></div></div>
                </div>`;
            
            const container = document.getElementById("three-container");
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            const camera = new THREE.PerspectiveCamera(85, window.innerWidth / window.innerHeight, 0.01, 3000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 3.5); 
            scene.add(ambient);
            const pointLight = new THREE.PointLight(0xffffff, 30);
            scene.add(pointLight);

            const loader = new GLTFLoader();
            loader.load('SMALL_INTESTINE.glb', (gltf) => {
                const model = gltf.scene;
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
                model.rotation.y = (140 * Math.PI / 180); 
                model.position.x -= 0.5;
                scene.add(model);

                let startZ = -size.z * 0.15; 
                let endZ = size.z * 1.5; 
                let currentZoom = startZ;

                function updateZoom(delta) {
                    currentZoom += delta;
                    if (currentZoom < startZ) currentZoom = startZ;
                    const progress = Math.abs((currentZoom - startZ) / (endZ - startZ)) * 100;
                    const fill = document.getElementById("zoom-bar-fill");
                    if(fill) fill.style.width = Math.min(100, progress) + "%";

                    if (currentZoom >= endZ) {
                        window.removeEventListener("keydown", handleKeyZoom);
                        renderer.dispose();
                        renderMicrobeView();
                    }
                }

                function handleKeyZoom(e) {
                    if (e.key === "ArrowUp") updateZoom(size.z / 250); 
                    if (e.key === "ArrowDown") updateZoom(-(size.z / 250));
                }

                window.addEventListener("keydown", handleKeyZoom);
                camera.position.z = startZ;

                function animate() {
                    if (!stage2.classList.contains("active")) return;
                    requestAnimationFrame(animate);
                    camera.position.z = currentZoom;
                    camera.position.x = Math.sin(currentZoom * 0.1) * 0.2; 
                    camera.lookAt(0, 0, currentZoom + 1);
                    pointLight.position.copy(camera.position);
                    renderer.render(scene, camera);
                }
                animate();
            }, undefined, (err) => {
                console.error("3D Load Failed", err);
                setTimeout(renderMicrobeView, 2000);
            });
        }

        function renderMicrobeView() {
            stage2.innerHTML = `
                <div class="text-header-container">
                    <h3>MIXING_MICROBIOTA</h3>
                    <p style="opacity:0.6;">DRAG ELEMENTS TO THE CENTRAL CHANNEL</p>
                </div>
                <div id="microbe-full-container">
                    <div id="center-lane"></div>
                </div>
                <div id="mix-status-floating">MIX_STATUS: 0 / 10</div>`;
            
            const container = document.getElementById("microbe-full-container");
            let mixedCount = 0;

            for (let i = 0; i < 20; i++) {
                const m = document.createElement("div");
                m.className = "microbe";
                m.style.backgroundColor = (i < 10 ? "#afeeee" : "#39ff14");
                m.id = "m-" + i;
                
                // Spread across the full screen width, avoiding center
                const side = i < 10 ? Math.random()*30 : Math.random()*30 + 70;
                m.style.left = side + "vw";
                m.style.top = Math.random()*80 + 10 + "vh";
                
                // Staggered animation delays for natural feel
                m.style.animationDelay = (Math.random() * 5) + "s";
                
                m.draggable = true;
                m.ondragstart = (e) => {
                    e.dataTransfer.setData("text", e.target.id);
                    e.target.style.animation = 'none'; // Stop floating while dragging
                };
                container.appendChild(m);
            }

            container.ondragover = (e) => e.preventDefault();
            container.ondrop = (e) => {
                e.preventDefault();
                const id = e.dataTransfer.getData("text");
                const el = document.getElementById(id);
                if (!el) return;
                
                const x = e.clientX;
                const y = e.clientY;

                el.style.left = (x - 22) + 'px';
                el.style.top = (y - 22) + 'px';

                // Check if dropped in center 20% of screen
                const screenCenter = window.innerWidth / 2;
                if (!el.dataset.isMixed && Math.abs(x - screenCenter) < window.innerWidth * 0.1) {
                    el.style.backgroundColor = "#333";
                    el.dataset.isMixed = "true";
                    mixedCount++;
                    document.getElementById("mix-status-floating").textContent = "MIX_STATUS: " + mixedCount + " / 10";
                    if (mixedCount >= 10) setTimeout(initStage3, 800);
                }
            };
        }

        function initStage3() {
            stage2.classList.remove("active");
            stage3.classList.add("active");
            stage3.innerHTML = `
                <div class="text-header-container"><h2>STAGE 3: VASODILATION</h2></div>
                <div style="width:400px; height:150px; background:white; margin:20px 0; border:2px solid black; position:relative; z-index:100;">
                    <div id="heat-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; transition:background 0.1s; pointer-events:none;"></div>
                </div>
                <p>PRESS SPACE REPEATEDLY</p>
                <p id="heat-level">HEAT_LEVEL: 0%</p>`;
            let presses = 0;
            const spaceHandler = (e) => {
                if (e.code === "Space") {
                    presses++;
                    const pct = Math.min(100, (presses / 30) * 100);
                    document.getElementById("heat-level").textContent = "HEAT_LEVEL: " + Math.round(pct) + "%";
                    document.getElementById("heat-overlay").style.backgroundColor = "rgba(0, 0, 0, " + (pct/100) + ")";
                    if (presses >= 30) {
                        document.removeEventListener("keydown", spaceHandler);
                        goToOxytocin();
                    }
                }
            };
            document.addEventListener("keydown", spaceHandler);
        }

        function goToOxytocin() {
            const formula = "C43H66N12O12S2";
            stage3.innerHTML = `
                <div class="text-header-container"><h3>SYNTHESIS: OXYTOCIN</h3><p>REQ: ${formula}</p></div>
                <input type="text" id="oxy-input" spellcheck="false" autocomplete="off" style="padding:10px; border:2px solid black; width:320px; font-family: 'Source Code Pro', monospace; font-size: 1.1em; outline: none; z-index:100; position:relative;">
                <p style="margin-top:15px; font-size:0.8em; opacity:0.6;">MATCH ENCRYPTED STRING EXACTLY</p>`;
            const input = document.getElementById("oxy-input");
            input.focus();
            input.oninput = (e) => {
                if (e.target.value.toUpperCase() === formula) {
                    document.getElementById("conclusion").classList.add("active");
                    stage3.classList.remove("active");
                    document.getElementById("conclusion").innerHTML = "<h2 style='text-align:center;'>OXYTOCIN_RELEASED<br>NEURAL_BOND_STABILIZED<br>PROCESS_COMPLETE</h2>";
                }
            };
        }

        initStage1();
    </script>
</body>
</html>
